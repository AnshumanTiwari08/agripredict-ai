<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDA - Crop Yield Prediction</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
  <link rel="stylesheet" href="{{ url_for('serve_css', filename='style.css') }}">
  <style>
    /* Existing EDA styles */
    .eda-visualizations {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }

    .eda-card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 2px solid transparent;
    }

    .eda-card h3 {
      font-family: 'Montserrat', sans-serif;
      color: #2d5016;
      margin-bottom: 1.5rem;
      text-align: center;
      font-size: 1.3rem;
    }

    /* New wrapper for the image to control its container size */
    .visualization-image-wrapper {
      width: 100%;
      /* Increased height for a bigger display */
      height: 400px;
      border-radius: 8px;
      overflow: hidden; /* Keep overflow hidden to contain the image */
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display: flex; /* Use flexbox to center the image */
      align-items: center; /* Center vertically */
      justify-content: center; /* Center horizontally */
    }

    .visualization-image-wrapper img {
      max-width: 100%; /* Ensure image doesn't overflow its container */
      max-height: 100%; /* Ensure image doesn't overflow its container */
      object-fit: contain; /* This is the key: scales the image to fit without cropping */
      transition: transform 0.3s ease;
    }

    .eda-card:hover .visualization-image-wrapper img {
      transform: scale(1.02); /* Slightly less aggressive zoom on hover to avoid cutting off */
    }

    .visualization-description {
      color: #666;
      font-size: 0.95rem;
      text-align: center;
      line-height: 1.6;
    }

    .insight-highlight {
      color: #2d5016;
      font-weight: 600;
      margin-top: 1rem;
      padding: 0.5rem;
      background: rgba(77, 124, 89, 0.1);
      border-radius: 6px;
      text-align: center;
    }

    .eda-display-area {
      /* Increased min-height to accommodate larger images */
      min-height: 500px;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 2rem;
      margin-top: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed #4a7c59;
    }

    .generated-analysis-section {
      display: none;
      margin-top: 3rem;
      padding: 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .timeframe-note {
      text-align: center;
      color: #666;
      font-style: italic;
      margin-bottom: 2rem;
      padding: 1rem;
      background: rgba(77, 124, 89, 0.1);
      border-radius: 8px;
    }

    /* Responsive adjustments for the new wrapper */
    @media (max-width: 768px) {
      .visualization-image-wrapper {
        height: 300px; /* Adjust height for smaller screens */
      }
      .eda-display-area {
        min-height: 400px; /* Adjust min-height for smaller screens */
      }
    }

    @media (max-width: 480px) {
      .visualization-image-wrapper {
        height: 250px; /* Further adjust height for very small screens */
      }
      .eda-display-area {
        min-height: 350px; /* Further adjust min-height for very small screens */
      }
    }
  </style>
</head>
<body>

  <header>
    <a href="{{ url_for('index') }}" class="logo">ðŸŒ¾ AgriPredict AI ðŸŒ±</a>
    <nav>
      <ul>
        <li><a href="{{ url_for('index') }}">Home</a></li>
        <li><a href="{{ url_for('about') }}">About</a></li>
        <li><a href="{{ url_for('predict') }}">Predict</a></li>
        <li><a href="{{ url_for('eda') }}">EDA</a></li>
        <li><a href="{{ url_for('contact') }}">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="hero-section">
      <div class="container hero-container">
        <h1>Exploratory Data Analysis</h1>
        <p>Comprehensive agricultural data insights and statistical visualizations</p>
      </div>
    </section>

    <section class="eda-section">
      <div class="container">
        <h2>Agricultural Data Insights (Pre-generated)</h2>
        
        <div class="timeframe-note">
          <i class="fas fa-info-circle"></i> Data analysis based on agricultural statistics from 2000 to 2024
        </div>
        
        <div class="eda-buttons">
          <button class="button eda-btn" onclick="showEDA('top5_crops')"><i class="fas fa-trophy"></i> Top 5 Crops</button>
          <button class="button eda-btn" onclick="showEDA('top10_states')"><i class="fas fa-map-marker-alt"></i> Top 10 States</button>
          <button class="button eda-btn" onclick="showEDA('yield_distribution')"><i class="fas fa-chart-bar"></i> Yield Distribution</button>
          <button class="button eda-btn" onclick="showEDA('area_vs_production')"><i class="fas fa-balance-scale"></i> Area vs Production</button>
          <button class="button eda-btn" onclick="showEDA('production_by_season')"><i class="fas fa-calendar-alt"></i> Seasonal Production</button>
          <button class="button eda-btn" onclick="showEDA('production_trends')"><i class="fas fa-chart-line"></i> Production Trends</button>
          <button class="button eda-btn" onclick="showEDA('correlation_heatmap')"><i class="fas fa-fire"></i> Correlation Heatmap</button>
        </div>

        <div class="eda-display-area" id="edaDisplay">
          <p style="color: #666; text-align: center;">
            <i class="fas fa-mouse-pointer" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
            Select an analysis from the buttons above to view the pre-generated visualization
          </p>
        </div>
      </div>
    </section>

    <section class="csv-upload-eda-section">
      <div class="container">
        <h2>Generate Custom Analysis (Upload Your CSV)</h2>
        <p class="csv-hint">Upload your agricultural data CSV file to generate personalized visualizations and insights</p>
        
        <div class="csv-upload-area">
          <label for="csv_graph_file" class="button cta-btn-secondary">
            <i class="fas fa-file-upload"></i> Choose CSV File
          </label>
          <input type="file" id="csv_graph_file" name="csv_graph_file" accept=".csv" style="display: none;">
          <span id="file-name">No file chosen</span>
          <button class="button cta-btn-primary" onclick="uploadCsvForGraph()">
            <i class="fas fa-chart-line"></i> Generate Analysis
          </button>
        </div>

        <div class="generated-analysis-section" id="generatedAnalysisSection">
          <h3>Generated Analysis Options</h3>
          <div class="eda-buttons" id="generatedEdaButtons">
            <!-- Buttons will be dynamically added here after CSV upload -->
          </div>
          
          <div class="eda-display-area" id="generatedGraphDisplay">
            <p style="color: #666; text-align: center;">
              <i class="fas fa-mouse-pointer" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
              Select a generated analysis from the buttons above to view the visualization
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>AgriPredict AI</h3>
        <p>Advanced Agricultural Data Analysis and Yield Prediction Platform</p>
      </div>
      <div class="footer-section">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="{{ url_for('index') }}">Home</a></li>
          <li><a href="{{ url_for('about') }}">About</a></li>
          <li><a href="{{ url_for('predict') }}">Predict</a></li>
          <li><a href="{{ url_for('eda') }}">Data Analysis</a></li>
          <li><a href="{{ url_for('contact') }}">Contact</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Data Sources</h4>
        <p>Agricultural research data, weather patterns, soil analysis, and historical yield records</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2023 AgriPredict AI - Agricultural Data Analysis Platform</p>
    </div>
  </footer>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="{{ url_for('serve_js', filename='script.js') }}"></script>
  <script>
    // Initialize AOS animations (ensure this is only called once, either here or in script.js)
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof AOS !== 'undefined') {
        AOS.init({
          duration: 1000,
          once: true,
          easing: 'ease-in-out'
        });
      }
    });

    // Store the visualizations data received from the server after CSV upload
    let uploadedVisualizationsData = {};

    // Function to show EDA visualization (for pre-generated images)
    async function showEDA(edaType) {
      const edaDisplay = document.getElementById('edaDisplay');
      edaDisplay.innerHTML = `<p style="color: #666; text-align: center;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Loading analysis...</p>`;

      try {
        // Fetch the URL of the pre-generated image
        const response = await fetch(`/api/eda/${edaType}`);
        const data = await response.json();

        if (data.image) { // data.image will now be a URL like /static/eda_images/top5_crops.png
          const titleMap = {
            'top5_crops': 'Top 5 Crops by Production',
            'top10_states': 'Top 10 States by Production',
            'yield_distribution': 'Yield Distribution (Tonnes/Hectare)',
            'area_vs_production': 'Area vs Production by Crop',
            'production_by_season': 'Production by Season',
            'production_trends': 'Total Production Over Years',
            'correlation_heatmap': 'Correlation Heatmap'
          };
          const descriptionMap = {
            'top5_crops': 'Analysis of the most productive crops showing top performers in terms of total yield.',
            'top10_states': 'Geographical distribution analysis showing top agricultural producers.',
            'yield_distribution': 'Statistical distribution of crop yields showing average productivity.',
            'area_vs_production': 'Correlation analysis between cultivated area and total production.',
            'production_by_season': 'Seasonal production analysis showing contribution of different seasons.',
            'production_trends': 'Historical trend analysis showing consistent growth in agricultural production.',
            'correlation_heatmap': 'Correlation analysis between key agricultural factors.'
          };
          const insightMap = {
            'top5_crops': 'Key crops drive overall production.',
            'yield_distribution': 'Yields vary, indicating opportunities for optimization.',
            'area_vs_production': 'Efficiency varies across different crop types.',
            'production_by_season': 'Seasonal patterns significantly impact total output.',
            'production_trends': 'Overall agricultural output shows a positive trend.',
            'correlation_heatmap': 'Strong relationships exist between environmental factors and yield.'
          };
          // Special insight for top10_states as it was missing
          if (edaType === 'top10_states') {
              insightMap['top10_states'] = 'Regional strengths in agriculture are evident.';
          }


          edaDisplay.innerHTML = `
            <div class="eda-card">
              <h3>${titleMap[edaType] || edaType}</h3>
              <div class="visualization-image-wrapper">
                <img src="${data.image}" alt="${titleMap[edaType] || edaType}">
              </div>
              <p class="visualization-description">${descriptionMap[edaType] || ''}</p>
              <div class="insight-highlight">${insightMap[edaType] || ''}</div>
            </div>
          `;
        } else {
          // Display error message if image is not returned or an error occurred
          edaDisplay.innerHTML = `<p style="color: #d9534f; text-align: center;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Error loading visualization: ${data.error || 'Unknown error'}</p>`;
        }
      } catch (error) {
        // Catch network errors
        edaDisplay.innerHTML = `<p style="color: #d9534f; text-align: center;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Network error: ${error}</p>`;
      }
    }

    // Function to show dynamically generated EDA visualization (for uploaded CSVs)
    function showGeneratedEDA(edaType) {
      const generatedDisplay = document.getElementById('generatedGraphDisplay');
      const imageData = uploadedVisualizationsData[edaType]; // Get base64 image data from stored data

      if (!imageData) {
        generatedDisplay.innerHTML = `<p style="color: #d9534f; text-align: center;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Visualization not available for this data.</p>`;
        return;
      }

      const titleMap = {
      'top5_crops': 'Top 5 Crops by Production',
      'top10_states': 'Top 10 States by Production',
      'yield_distribution': 'Yield Distribution (Tonnes/Hectare)',
      'area_vs_production': 'Area vs Production by Crop',
      'production_by_season': 'Production by Season',
      'production_trends': 'Total Production Over Years',
      'correlation_heatmap': 'Correlation Heatmap'
      };

      generatedDisplay.innerHTML = `
      <div class="eda-card">
        <h3>${titleMap[edaType] || edaType}</h3>
        <div class="visualization-image-wrapper">
        <img src="${imageData}" alt="Generated Analysis: ${titleMap[edaType] || edaType}">
        </div>
        <p class="visualization-description">Custom analysis generated from your uploaded CSV data.</p>
        <div class="insight-highlight">Insight: This visualization helps understand ${titleMap[edaType].toLowerCase()}.</div>
      </div>
      `;
    }

    // Handle file input change for CSV upload
    document.getElementById('csv_graph_file').addEventListener('change', function() {
      const fileNameSpan = document.getElementById('file-name');
      if (this.files.length > 0) {
        fileNameSpan.textContent = this.files[0].name;
        // Clear previous generated analysis when a new file is chosen
        document.getElementById('generatedAnalysisSection').style.display = 'none';
        document.getElementById('generatedEdaButtons').innerHTML = '';
        document.getElementById('generatedGraphDisplay').innerHTML = '<p style="color: #666; text-align: center;"><i class="fas fa-mouse-pointer" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Select a generated analysis from the buttons above to view the visualization</p>';
        uploadedVisualizationsData = {}; // Clear stored data
      } else {
        fileNameSpan.textContent = 'No file chosen';
      }
    });

    // Function to simulate CSV upload and show generated analysis section
    async function uploadCsvForGraph() {
      const fileInput = document.getElementById('csv_graph_file');
      const generatedSection = document.getElementById('generatedAnalysisSection');
      const generatedGraphDisplay = document.getElementById('generatedGraphDisplay');
      const generatedEdaButtons = document.getElementById('generatedEdaButtons');

      if (fileInput.files.length === 0) {
        alert('Please select a CSV file to upload');
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('csv_file', file);

      generatedSection.style.display = 'block';
      generatedGraphDisplay.innerHTML = `
        <div style="text-align: center;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
          <p>Processing your agricultural data: <strong>${file.name}</strong></p>
          <p style="color: #666; font-size: 0.9rem;">Analyzing crop patterns and generating insights...</p>
        </div>
      `;
      generatedEdaButtons.innerHTML = ''; // Clear previous buttons

      try {
        const response = await fetch('/api/upload-csv', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();

        if (data.success) {
          uploadedVisualizationsData = data.visualizations; // Store the received base64 image data

          generatedGraphDisplay.innerHTML = `<p style="color: #666; text-align: center;"><i class="fas fa-mouse-pointer" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Select a generated analysis from the buttons above to view the visualization</p>`;
          
          const vizTypes = {
            'top5_crops': 'Top 5 Crops',
            'top10_states': 'Top 10 States',
            'yield_distribution': 'Yield Distribution',
            'area_vs_production': 'Area vs Production',
            'production_by_season': 'Seasonal Production',
            'production_trends': 'Production Trends',
            'correlation_heatmap': 'Correlation Heatmap'
          };

          let buttonsGenerated = false;
          for (const type in vizTypes) { // Iterate through all possible visualization types
            // Only create button if the visualization was successfully generated (i.e., not null)
            if (uploadedVisualizationsData[type]) { 
              const button = document.createElement('button');
              button.className = 'button eda-btn';
              button.innerHTML = `<i class="fas fa-chart-bar"></i> ${vizTypes[type]}`;
              // Call showGeneratedEDA without passing imageUrl directly, it will get it from uploadedVisualizationsData
              button.onclick = () => showGeneratedEDA(type); 
              generatedEdaButtons.appendChild(button);
              buttonsGenerated = true;
            } else {
                // Optionally, add a disabled button or a message if a specific viz failed
                const button = document.createElement('button');
                button.className = 'button eda-btn disabled';
                button.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${vizTypes[type]} (N/A)`;
                button.disabled = true;
                button.title = "Visualization could not be generated from your CSV data.";
                generatedEdaButtons.appendChild(button);
            }
          }
          if (!buttonsGenerated) {
            generatedEdaButtons.innerHTML = `<p style="color: #666; text-align: center;">No visualizations could be generated from this CSV. Please check your data columns.</p>`;
          }

        } else {
          generatedGraphDisplay.innerHTML = `<p style="color: #d9534f; text-align: center;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Error processing CSV: ${data.error || 'Unknown error'}</p>`;
        }
      } catch (error) {
        generatedGraphDisplay.innerHTML = `<p style="color: #d9534f; text-align: center;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i> Network error during CSV upload: ${error}</p>`;
      }
    }
  </script>
</body>
</html>
